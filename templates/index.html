<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programmierungswettbewerb</title>
    <style>
        /* Grundlayout */
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            margin-bottom: 10px;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(30, 24px);
            grid-template-rows: repeat(20, 24px);
            gap: 1px;
            background: #333;
            padding: 1px;
        }
        .cell {
            width: 24px;
            height: 24px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            user-select: none;
        }
        .loot {
            font-size: 16px;
            color: gold;
        }
        /* Spielerfarben */
        .player1 { color: #e74c3c; }
        .player2 { color: #3498db; }
        .player3 { color: #2ecc71; }
        .player4 { color: #f39c12; }
        .player5 { color: #9b59b6; }
        .player6 { color: #1abc9c; }
        .player7 { color: #e67e22; }
    </style>
</head>
<body>
    <h1>Programmierungswettbewerb: Sterne sammeln</h1>
    <div id="board"></div>

    <script>
        // Ausgangsdaten aus Flask-Template (Jinja2)
        let players = {{ players | tojson }};   // z.B. [[4,1],[3,8],...]
        let loot    = {{ loot | tojson }};      // z.B. [[5,5],[10,12],...]
        let loop    = 0;

        const rows = 20;
        const cols = 30;
        const boardEl = document.getElementById('board');

        // Spielfeld initialisieren
        function initBoard() {
            boardEl.innerHTML = '';
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.id = `cell-${r}-${c}`;
                    cell.className = 'cell';
                    boardEl.appendChild(cell);
                }
            }
        }

        // Aktuelle Positionen auf das Feld zeichnen
        function draw() {
            // Leeren aller Zellen
            document.querySelectorAll('.cell').forEach(cell => cell.textContent = '');

            // Sterne zeichnen
            loot.forEach(([r,c]) => {
                const cell = document.getElementById(`cell-${r}-${c}`);
                cell.textContent = '★';
                cell.classList.add('loot');
            });

            // Spieler zeichnen
            players.forEach(([r,c], idx) => {
                const num = idx + 1;
                const cell = document.getElementById(`cell-${r}-${c}`);
                cell.textContent = num;
                cell.classList.add(`player${num}`);
            });
        }

        // Server-Anfrage für neuen Zug
        async function nextMove() {
            const payload = { player: players, loot: loot, loop: loop };
            try {
                const resp = await fetch('/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                // Neue Spielerkoordinaten übernehmen
                players = data.coord;
                loop++;

                // Gesammelte Sterne entfernen
                loot = loot.filter(([lr,lc]) => {
                    return !players.some(([pr,pc]) => pr === lr && pc === lc);
                });

                draw();

                // Prüfen, ob alle Sterne gesammelt sind
                if (loot.length === 0) {
                    clearInterval(gameInterval);
                    showWinner();
                }
            } catch (err) {
                console.error('Fehler bei move:', err);
            }
        }

        // Gewinner ermitteln und Animation zeigen
        function showWinner() {
            // Zähle gesammelte Sterne pro Spieler
            const counts = Array(7).fill(0);
            // loopweise könnte man Server mitliefern lassen, hier bitte anpassen
            alert('Spiel beendet! Gewinner wird ermittelt.');
            // (Hier können Sie eine lustige Animation implementieren.)
        }

        // Initialisierung
        initBoard();
        draw();
        // Spiel-Loop: alle 1000ms ein Zug
        const gameInterval = setInterval(nextMove, 1000);
    </script>
</body>
</html>
